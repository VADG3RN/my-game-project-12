<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∏—Ç–æ—á–∫–∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>–ü–ª–∏—Ç–æ—á–∫–∏</h1>
    <div id="easter-egg" title="–ü–∞—Å—Ö–∞–ª–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞!!!" onclick="playEasterEgg()">ü•ö</div>
    <div id="tutorial-button" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É" onclick="showHint()">‚ùì</div>
    <div id="hint">
        <b style="display: block; text-align: center;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</b>
        –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –ø–ª–∏—Ç–∫–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∏.
    </div>
    <div id="game-container">
        <div id="main-menu">
            <button onclick="playButtonSound(); continueGameMain()" id="continue-main" style="display: none;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button onclick="playButtonSound(); showNewGameMenu()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
        <div id="new-game-menu">
            <div class="menu-item">–ò–º—è –∏–≥—Ä–æ–∫–∞:<br><input type="text" id="player-name" maxlength="20" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"></div>
            <div class="menu-item">–°–ª–æ–∂–Ω–æ—Å—Ç—å:<br><select id="difficulty">
                <option value="3">–õ–µ–≥–∫–∏–π (3x3)</option>
                <option value="4">–°—Ä–µ–¥–Ω–∏–π (4x4)</option>
                <option value="5">–°–ª–æ–∂–Ω—ã–π (5x5)</option>
            </select></div>
            <div class="menu-item button-item"><button onclick="playButtonSound(); startNewGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button></div>
        </div>
        <div id="player-info"></div>
        <div id="game-board"></div>
        <div id="game-menu">
            <button onclick="playButtonSound(); resetGame()">–°–±—Ä–æ—Å</button>
            <button onclick="playButtonSound(); exitToMenu()">–í—ã—Ö–æ–¥</button>
        </div>
        <div id="info">
            <p>–•–æ–¥—ã: <span id="moves">0</span></p>
            <p>–í—Ä–µ–º—è: <span id="timer">00:00</span></p>
        </div>
        <div id="tutorial" class="hidden">
            <div id="tutorial-content">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ü–ª–∏—Ç–æ—á–∫–∏!</h2>
                <p>–ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –ø–ª–∏—Ç–∫–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É.</p>
                <p>–¶–µ–ª—å: —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –ø–ª–∏—Ç–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.</p>
                <button onclick="playButtonSound(); closeTutorial()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –∏ –∏–≥—Ä–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        const board = document.getElementById('game-board');
        const movesDisplay = document.getElementById('moves');
        const timerDisplay = document.getElementById('timer');
        const playerNameInput = document.getElementById('player-name');
        const difficultySelect = document.getElementById('difficulty');
        const tutorial = document.getElementById('tutorial');
        const mainMenu = document.getElementById('main-menu');
        const newGameMenu = document.getElementById('new-game-menu');
        const gameMenu = document.getElementById('game-menu');
        const continueMainButton = document.getElementById('continue-main');
        const hint = document.getElementById('hint');
        const tutorialButton = document.getElementById('tutorial-button');
        const playerInfo = document.getElementById('player-info');
        const gameContainer = document.getElementById('game-container');
        let tiles = [];
        let size = 3; // –†–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let moves = 0; // –°—á—ë—Ç—á–∏–∫ —Ö–æ–¥–æ–≤ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –æ—á–∫–æ–≤
        let timer = 0; // –¢–∞–π–º–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
        let timerInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
        let emptyIndex = size * size - 1; // –ò–Ω–¥–µ–∫—Å –ø—É—Å—Ç–æ–π –ø–ª–∏—Ç–∫–∏
        let isGameActive = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let currentImageUrl = ''; // URL —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let hintTimeout = null; // –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Howler.js (—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –∑–≤—É–∫–∞)
        const moveSound = new Howl({
            src: ['https://www.soundjay.com/buttons/sounds/button-11.mp3'],
            volume: 1.0
        }); // –ó–≤—É–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–ª–∏—Ç–∫–∏
        const winSound = new Howl({
            src: ['https://www.soundjay.com/misc/sounds/dream-harp-08.mp3'],
            volume: 1.0
        }); // –ó–≤—É–∫ –ø–æ–±–µ–¥—ã
        const easterSound = new Howl({
            src: ['https://www.soundjay.com/misc/sounds/magic-chime-01.mp3'],
            volume: 1.0
        }); // –ó–≤—É–∫ –ø–∞—Å—Ö–∞–ª–∫–∏
        const buttonSound = new Howl({
            src: ['https://www.soundjay.com/buttons/button-1.mp3'],
            volume: 0.8
        }); // –ó–≤—É–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫
        const hintSound = new Howl({
            src: ['https://www.soundjay.com/buttons/sounds/button-09a.mp3'],
            volume: 0.9
        }); // –ó–≤—É–∫ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        const backgroundMusic = new Howl({
            src: ['https://www.soundjay.com/free-music/sounds/heart-of-the-sea-01.mp3'],
            loop: true,
            volume: 0.5,
            preload: true
        }); // –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫ –∑–≤—É–∫–æ–≤
        moveSound.on('load', () => console.log('–ó–≤—É–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω'));
        winSound.on('load', () => console.log('–ó–≤—É–∫ –ø–æ–±–µ–¥—ã –∑–∞–≥—Ä—É–∂–µ–Ω'));
        easterSound.on('load', () => console.log('–ó–≤—É–∫ –ø–∞—Å—Ö–∞–ª–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω'));
        buttonSound.on('load', () => console.log('–ó–≤—É–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω'));
        hintSound.on('load', () => console.log('–ó–≤—É–∫ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω'));
        backgroundMusic.on('load', () => console.log('–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞'));
        backgroundMusic.on('loaderror', (id, err) => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏:', err));
        moveSound.on('playerror', (id, err) => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è moveSound:', err));
        winSound.on('playerror', (id, err) => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è winSound:', err));
        easterSound.on('playerror', (id, err) => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è easterSound:', err));
        buttonSound.on('playerror', (id, err) => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è buttonSound:', err));
        hintSound.on('playerror', (id, err) => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è hintSound:', err));
        backgroundMusic.on('playerror', (id, err) => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è backgroundMusic:', err));
        moveSound.load();
        winSound.load();
        easterSound.load();
        buttonSound.load();
        hintSound.load();
        backgroundMusic.load();

        // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        function playSound(sound) {
            try {
                const soundId = sound.play();
                if (!soundId) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫, –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª–∏—Ç–∏–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞:', sound._src);
                } else {
                    console.log('–ó–≤—É–∫ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω:', sound._src);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –∑–≤—É–∫–∞:', err);
            }
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ –∫–Ω–æ–ø–∫–∏
        function playButtonSound() {
            playSound(buttonSound);
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        function validatePlayerName(name) {
            const regex = /^[a-zA-Z–∞-—è–ê-–Ø0-9]{1,20}$/;
            return regex.test(name);
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ localStorage
        function saveProgress() {
            localStorage.setItem('puzzleProgress', JSON.stringify({
                playerName: playerNameInput.value,
                difficulty: size,
                moves: moves,
                timer: timer,
                tiles: tiles.map(tile => ({ index: tile.index })),
                emptyIndex: emptyIndex,
                imageUrl: currentImageUrl
            }));
            console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω:', JSON.parse(localStorage.getItem('puzzleProgress')));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function loadProgress() {
            const progress = JSON.parse(localStorage.getItem('puzzleProgress'));
            if (progress) {
                playerNameInput.value = progress.playerName || '';
                difficultySelect.value = progress.difficulty || 3;
                moves = progress.moves || 0;
                timer = progress.timer || 0;
                size = progress.difficulty || 3;
                tiles = progress.tiles ? progress.tiles.map((t, i) => ({ index: t.index, element: null })) : [];
                emptyIndex = progress.emptyIndex !== undefined ? progress.emptyIndex : size * size - 1;
                currentImageUrl = progress.imageUrl || '';
                movesDisplay.textContent = moves;
                updateTimerDisplay();
                if (tiles.length > 0) {
                    continueMainButton.style.display = 'block';
                }
                console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω:', progress);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ç—É—Ç–æ—Ä–∏–∞–ª–∞
        function closeTutorial() {
            tutorial.classList.add('hidden');
            localStorage.setItem('tutorialSeen', 'true');
            console.log('–¢—É—Ç–æ—Ä–∏–∞–ª –∑–∞–∫—Ä—ã—Ç');
            newGameMenu.style.display = 'flex';
        }

        // –ü–æ–∫–∞–∑ —Ç—É—Ç–æ—Ä–∏–∞–ª–∞
        function showTutorial() {
            console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ —Ç—É—Ç–æ—Ä–∏–∞–ª–∞');
            if (tutorial) {
                tutorial.classList.remove('hidden');
                tutorial.style.display = 'flex';
                console.log('–¢—É—Ç–æ—Ä–∏–∞–ª –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
            } else {
                console.error('–≠–ª–µ–º–µ–Ω—Ç #tutorial –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        }

        // –ü–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function showHint() {
            console.log('–ü–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏');
            if (hint && gameMenu.style.display === 'flex') {
                if (hintTimeout) clearTimeout(hintTimeout);
                playSound(hintSound);
                hint.style.display = 'block';
                hintTimeout = setTimeout(() => {
                    hint.style.display = 'none';
                    console.log('–ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥');
                }, 5000);
                console.log('–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞');
            } else {
                console.log('–ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω–µ –∏–≥—Ä–æ–≤–æ–≥–æ –º–µ–Ω—é');
            }
        }

        // –ü–æ–∫–∞–∑ –º–µ–Ω—é –Ω–æ–≤–æ–π –∏–≥—Ä—ã
        function showNewGameMenu() {
            console.log('–ü–æ–∫–∞–∑ –º–µ–Ω—é –Ω–æ–≤–æ–π –∏–≥—Ä—ã');
            mainMenu.style.display = 'none';
            newGameMenu.style.display = 'flex';
            playerNameInput.value = '';
            difficultySelect.value = '3';
            tutorialButton.style.display = 'none';
            showTutorial();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ API
        async function fetchImage() {
            let attempts = 0;
            const maxAttempts = 5;
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch('https://api.thecatapi.com/v1/images/search');
                    const data = await response.json();
                    const url = data[0].url;
                    if (!url.toLowerCase().endsWith('.gif')) {
                        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${url}`);
                        return url;
                    }
                    console.log(`–ü–æ–ª—É—á–µ–Ω GIF (${url}), –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ`);
                    attempts++;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                    attempts++;
                }
            }
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–µ');
            return 'https://via.placeholder.com/500';
        }

        // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
        async function startGame() {
            const playerName = playerNameInput.value.trim();
            if (!validatePlayerName(playerName)) {
                alert('–ò–º—è –∏–≥—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã, –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤.');
                return;
            }
            console.log('–ù–∞—á–∞–ª–æ –∏–≥—Ä—ã');
            newGameMenu.style.display = 'none';
            gameMenu.style.display = 'flex';
            size = parseInt(difficultySelect.value); // –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (3x3, 4x4, 5x5)
            emptyIndex = size * size - 1;
            moves = 0;
            timer = 0;
            movesDisplay.textContent = moves;
            updateTimerDisplay();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timer++;
                updateTimerDisplay();
                saveProgress();
            }, 1000); // –¢–∞–π–º–µ—Ä
            isGameActive = false;
            tiles = Array.from({ length: size * size }, (_, i) => ({ index: i, element: null }));
            const tileSize = Math.min(100, Math.floor((window.innerWidth * 0.8) / size));
            board.style.gridTemplateColumns = `repeat(${size}, ${tileSize}px)`;
            board.style.width = `${size * tileSize}px`;
            board.style.height = `${size * tileSize}px`;
            gameContainer.style.width = `${Math.max(300, size * tileSize + 40)}px`;
            board.style.display = 'grid';
            currentImageUrl = await fetchImage();
            await createBoard();
            playerInfo.textContent = `–ò–≥—Ä–æ–∫: ${playerName}, –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${size}x${size}`;
            playerInfo.style.display = 'block';
            document.getElementById('info').style.display = 'block';
            document.getElementById('easter-egg').style.display = 'block';
            tutorialButton.style.display = 'block';
            // –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
            if (!backgroundMusic.playing()) {
                playSound(backgroundMusic);
                console.log('–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞:', backgroundMusic.state());
            }
            console.log('–ü–æ–ª–µ —Å–æ–∑–¥–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞—é —Å–æ–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É 3 —Å–µ–∫—É–Ω–¥—ã');
            setTimeout(() => {
                console.log('–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –ø–ª–∏—Ç–æ–∫');
                shuffleTiles();
                isGameActive = true;
                saveProgress();
                console.log('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å');
            }, 3000);
        }

        // –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –∏–≥—Ä—ã —Å –æ—á–∏—Å—Ç–∫–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function startNewGame() {
            console.log('–ù–æ–≤–∞—è –∏–≥—Ä–∞');
            localStorage.removeItem('puzzleProgress');
            tiles = [];
            startGame();
        }

        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∏–≥—Ä—ã
        async function continueGameMain() {
            console.log('–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∏–≥—Ä—ã');
            const progress = JSON.parse(localStorage.getItem('puzzleProgress'));
            if (progress) {
                playerNameInput.value = progress.playerName || '';
                difficultySelect.value = progress.difficulty || 3;
                size = parseInt(progress.difficulty) || 3;
                moves = progress.moves || 0;
                timer = progress.timer || 0;
                tiles = progress.tiles ? progress.tiles.map((t, i) => ({ index: t.index, element: null })) : Array.from({ length: size * size }, (_, i) => ({ index: i, element: null }));
                emptyIndex = progress.emptyIndex !== undefined ? progress.emptyIndex : size * size - 1;
                currentImageUrl = progress.imageUrl || '';
                console.log('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', { tiles: tiles.map(t => t.index), emptyIndex });
                mainMenu.style.display = 'none';
                gameMenu.style.display = 'flex';
                movesDisplay.textContent = moves;
                updateTimerDisplay();
                const tileSize = Math.min(100, Math.floor((window.innerWidth * 0.8) / size));
                board.style.gridTemplateColumns = `repeat(${size}, ${tileSize}px)`;
                board.style.width = `${size * tileSize}px`;
                board.style.height = `${size * tileSize}px`;
                gameContainer.style.width = `${Math.max(300, size * tileSize + 40)}px`;
                board.style.display = 'grid';
                await createBoard();
                updateBoardState();
                playerInfo.textContent = `–ò–≥—Ä–æ–∫: ${playerNameInput.value}, –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${size}x${size}`;
                playerInfo.style.display = 'block';
                document.getElementById('info').style.display = 'block';
                document.getElementById('easter-egg').style.display = 'block';
                tutorialButton.style.display = 'block';
                isGameActive = true;
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timer++;
                    updateTimerDisplay();
                    saveProgress();
                }, 1000); // –¢–∞–π–º–µ—Ä
                // –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏
                if (!backgroundMusic.playing()) {
                    playSound(backgroundMusic);
                    console.log('–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏:', backgroundMusic.state());
                }
                saveProgress();
                logBoardState();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
        function updateTimerDisplay() {
            const minutes = Math.floor(timer / 60).toString().padStart(2, '0');
            const seconds = (timer % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        function logBoardState() {
            let boardState = '–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—è:\n';
            for (let i = 0; i < size; i++) {
                let row = '';
                for (let j = 0; j < size; j++) {
                    const pos = i * size + j;
                    const tile = tiles[pos];
                    row += (tile.index === size * size - 1 ? '[ ]' : (tile.index + 1).toString().padStart(3)) + ' ';
                }
                boardState += row + '\n';
            }
            console.log(boardState);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        async function createBoard() {
            board.innerHTML = '';
            const tileSize = Math.min(100, Math.floor((window.innerWidth * 0.8) / size));
            tiles.forEach((tile, i) => {
                const tileEl = document.createElement('div');
                tileEl.classList.add('tile');
                tileEl.dataset.pos = i.toString();
                tileEl.style.width = `${tileSize}px`;
                tileEl.style.height = `${tileSize}px`;
                tileEl.style.backgroundImage = `url(${currentImageUrl})`;
                tileEl.style.backgroundSize = `${size * tileSize}px ${size * tileSize}px`;
                tileEl.addEventListener('click', () => {
                    if (!isGameActive) return;
                    const pos = parseInt(tileEl.dataset.pos);
                    console.log(`–ö–ª–∏–∫ –ø–æ –ø–ª–∏—Ç–∫–µ: pos=${pos}, tile=${tiles[pos].index + 1}`);
                    logBoardState();
                    moveTile(pos); // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
                });
                console.log(`–î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏: ${i}`);
                board.appendChild(tileEl);
                tiles[i].element = tileEl;
            });
            document.removeEventListener('keydown', handleKeyPress);
            document.addEventListener('keydown', handleKeyPress); // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            updateBoardState();
            console.log('–ü–æ–ª–µ —Å–æ–∑–¥–∞–Ω–æ, tiles:', tiles.map(t => t.index));
        }

        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –ø–ª–∏—Ç–æ–∫
        function shuffleTiles() {
            console.log('–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –ø–ª–∏—Ç–æ–∫');
            for (let k = 0; k < 3; k++) {
                for (let i = tiles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [tiles[i].index, tiles[j].index] = [tiles[j].index, tiles[i].index];
                }
            }
            emptyIndex = tiles.findIndex(t => t.index === size * size - 1);
            if (size === 3 && !isSolvable()) {
                console.log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ—Ä–µ—à–∞–µ–º–∞, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º');
                let idx1 = 0, idx2 = 1;
                while (tiles[idx1].index === size * size - 1) idx1++;
                while (tiles[idx2].index === size * size - 1 || idx2 === idx1) idx2++;
                [tiles[idx1].index, tiles[idx2].index] = [tiles[idx2].index, tiles[idx1].index];
            }
            emptyIndex = tiles.findIndex(t => t.index === size * size - 1);
            updateBoardState();
            if (isSolved()) {
                console.log('–ü–æ–ª–µ —Ä–µ—à–µ–Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è, –ø–æ–≤—Ç–æ—Ä—è–µ–º');
                shuffleTiles();
            } else {
                console.log('–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                logBoardState();
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–∏–º–æ—Å—Ç–∏ –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∏
        function isSolvable() {
            let inversions = 0;
            const tileOrder = tiles.map(t => t.index === size * size - 1 ? 0 : t.index + 1);
            for (let i = 0; i < tileOrder.length - 1; i++) {
                for (let j = i + 1; j < tileOrder.length; j++) {
                    if (tileOrder[i] && tileOrder[j] && tileOrder[i] > tileOrder[j]) {
                        inversions++;
                    }
                }
            }
            const emptyRowFromBottom = size - Math.floor(emptyIndex / size);
            return (inversions + emptyRowFromBottom) % 2 === 0;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        function updateBoardState() {
            const tileSize = Math.min(100, Math.floor((window.innerWidth * 0.8) / size));
            tiles.forEach((tile, pos) => {
                if (tile.element) {
                    tile.element.dataset.pos = pos.toString();
                    tile.element.style.width = `${tileSize}px`;
                    tile.element.style.height = `${tileSize}px`;
                    if (tile.index === size * size - 1) {
                        tile.element.classList.add('empty');
                        tile.element.style.backgroundImage = '';
                        tile.element.style.backgroundPosition = '';
                    } else {
                        tile.element.classList.remove('empty');
                        tile.element.style.backgroundImage = `url(${currentImageUrl})`;
                        tile.element.style.backgroundSize = `${size * tileSize}px ${size * tileSize}px`;
                        tile.element.style.backgroundPosition = `${-(tile.index % size) * tileSize}px ${-Math.floor(tile.index / size) * tileSize}px`;
                    }
                }
            });
            console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ, tiles:', tiles.map(t => t.index));
        }

        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–ª–∏—Ç–∫–∏ (—Å–æ–±—ã—Ç–∏—è –º—ã—à–∏)
        function moveTile(pos) {
            if (!isGameActive || tiles[pos].index === size * size - 1) {
                console.log(`–ö–ª–∏–∫ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω: pos=${pos}, isGameActive=${isGameActive}, isEmpty=${tiles[pos].index === size * size - 1}`);
                return;
            }
            const emptyRow = Math.floor(emptyIndex / size);
            const emptyCol = emptyIndex % size;
            const tileRow = Math.floor(pos / size);
            const tileCol = pos % size;
            console.log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–ª–∏—Ç–∫—É: pos=${pos}, tile=${tiles[pos].index + 1}, tileRow=${tileRow}, tileCol=${tileCol}, emptyIndex=${emptyIndex}, emptyRow=${emptyRow}, emptyCol=${emptyCol}`);
            if ((Math.abs(emptyRow - tileRow) === 1 && emptyCol === tileCol) ||
                (Math.abs(emptyCol - tileCol) === 1 && emptyRow === tileRow)) {
                console.log(`–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ: –ø–ª–∏—Ç–∫–∞ ${tiles[pos].index + 1} (pos ${pos}) -> –ø—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞ (pos ${emptyIndex})`);
                [tiles[emptyIndex].index, tiles[pos].index] = [tiles[pos].index, tiles[emptyIndex].index];
                emptyIndex = pos;
                moves++;
                movesDisplay.textContent = moves;
                playSound(moveSound);
                updateBoardState();
                logBoardState();
                saveProgress();
                if (isSolved()) {
                    isGameActive = false;
                    clearInterval(timerInterval);
                    const score = Math.max(0, 10000 - (moves * 10) - timer); // –°–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤
                    playSound(winSound);
                    setTimeout(() => {
                        alert(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, ${playerNameInput.value}! –í—ã —Å–æ–±—Ä–∞–ª–∏ –≥–æ–ª–æ–≤–æ–ª–æ–º–∫—É! –•–æ–¥—ã: ${moves}, –í—Ä–µ–º—è: ${timer} —Å–µ–∫, –û—á–∫–∏: ${score}`);
                        exitToMenu();
                    }, 500);
                }
            } else {
                console.log(`–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ: –ø–ª–∏—Ç–∫–∞ ${tiles[pos].index + 1} (pos ${pos}) –Ω–µ —Å–æ—Å–µ–¥—Å—Ç–≤—É–µ—Ç —Å –ø—É—Å—Ç–æ–π –∫–ª–µ—Ç–∫–æ–π (pos ${emptyIndex})`);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–µ—à–µ–Ω–∞ –ª–∏ –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞
        function isSolved() {
            const solved = tiles.every((tile, i) => tile.index === i);
            console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è: solved=${solved}, tiles=${JSON.stringify(tiles.map(t => t.index))}`);
            return solved;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        function handleKeyPress(e) {
            if (!isGameActive) return;
            let newEmptyIndex = emptyIndex;
            if (e.key === 'ArrowUp' && emptyIndex >= size) newEmptyIndex -= size;
            if (e.key === 'ArrowDown' && emptyIndex < size * (size - 1)) newEmptyIndex += size;
            if (e.key === 'ArrowLeft' && emptyIndex % size > 0) newEmptyIndex -= 1;
            if (e.key === 'ArrowRight' && emptyIndex % size < size - 1) newEmptyIndex += 1;
            if (newEmptyIndex !== emptyIndex) {
                console.log(`–°—Ç—Ä–µ–ª–∫–∞: –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–π –∫–ª–µ—Ç–∫–∏ —Å pos ${emptyIndex} –Ω–∞ pos ${newEmptyIndex}`);
                moveTile(newEmptyIndex);
            }
        }

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–∞—Å—Ö–∞–ª–∫–∏
        function playEasterEgg() {
            playSound(easterSound);
            alert('–ü–∞—Å—Ö–∞–ª–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞: –ø–∞–∑–ª —Å–æ–±—Ä–∞–Ω!');
            solvePuzzle();
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∏
        function solvePuzzle() {
            for (let i = 0; i < tiles.length; i++) {
                tiles[i].index = i;
            }
            emptyIndex = size * size - 1;
            updateBoardState();
            logBoardState();
            saveProgress();
            isGameActive = false;
            clearInterval(timerInterval);
            const score = Math.max(0, 10000 - (moves * 10) - timer); // –°–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤
            playSound(winSound);
            setTimeout(() => {
                alert(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, ${playerNameInput.value}! –í—ã —Å–æ–±—Ä–∞–ª–∏ –ø–∞–∑–ª! –•–æ–¥—ã: ${moves}, –í—Ä–µ–º—è: ${timer} —Å–µ–∫, –û—á–∫–∏: ${score}`);
            }, 500);
        }

        // –°–±—Ä–æ—Å –∏–≥—Ä—ã
        function resetGame() {
            console.log('–°–±—Ä–æ—Å –∏–≥—Ä—ã');
            moves = 0;
            timer = 0;
            movesDisplay.textContent = moves;
            updateTimerDisplay();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timer++;
                updateTimerDisplay();
                saveProgress();
            }, 1000); // –¢–∞–π–º–µ—Ä
            shuffleTiles();
            isGameActive = true;
            saveProgress();
            logBoardState();
        }

        // –í—ã—Ö–æ–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        function exitToMenu() {
            console.log('–í—ã—Ö–æ–¥ –≤ –º–µ–Ω—é');
            if (timerInterval) clearInterval(timerInterval);
            if (hintTimeout) clearTimeout(hintTimeout);
            hint.style.display = 'none';
            isGameActive = false;
            board.innerHTML = '';
            board.style.display = 'none';
            movesDisplay.textContent = moves;
            updateTimerDisplay();
            document.getElementById('info').style.display = 'none';
            document.getElementById('easter-egg').style.display = 'none';
            tutorialButton.style.display = 'none';
            playerInfo.style.display = 'none';
            mainMenu.style.display = 'flex';
            newGameMenu.style.display = 'none';
            gameMenu.style.display = 'none';
            gameContainer.style.width = 'clamp(300px, 80vw, 500px)'; // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
            continueMainButton.style.display = localStorage.getItem('puzzleProgress') ? 'block' : 'none';
            saveProgress();
            backgroundMusic.stop(); // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏
            console.log('–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', backgroundMusic.state());
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadProgress();
    </script>
</body>
</html>